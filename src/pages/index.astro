---
// 1. IMPORTS (Using your new Aliases)
import BaseLayout from '@layouts/BaseLayout.astro';
import Navbar from '@components/Navbar.astro';
import ProjectRow from '@components/ProjectRow.astro';
import { getCollection } from 'astro:content';

// 2. DATA LOGIC (This was missing/broken)
const allProjects = await getCollection('projects');

// Filter for featured projects & sort by order (exclude archived - explicit boolean check)
const featuredProjects = allProjects
  .filter((project) => project.data.featured && project.data.archived !== true)
  .sort((a, b) => a.data.order - b.data.order);
---

<BaseLayout title="Nikhil R. Nigam | ML Engineer">
  <Navbar />

  <header class="hero-section">
    <div class="hero-grid">
      <div class="hero-left">
        <h1>Nikhil R. Nigam</h1>
        <div class="role-wrapper">
          <span>Machine Learning Engineer</span>
          <span class="cursor"></span>
        </div>
        <p class="hero-bio">
            I build the infrastructure that makes AI reliable. 
            From <strong>Sub-second Vector Search</strong> to <strong>Privacy-First RAG systems</strong>, 
            I bridge the gap between research prototypes and production durability.
        </p>
        
        <div class="hero-actions">
            <a href="mailto:niknigam96@gmail.com" class="cta-btn">Get in Touch</a>
            <a href="/resume.pdf" download="Nikhil_Nigam_Resume.pdf" class="cta-btn-outline">Download Resume ↓</a>
        </div>
      </div>

      <div class="tech-container">
        <div class="tech-header">
          <div class="status-dot"></div>
          <span>SYSTEM KERNEL [ONLINE]</span>
        </div>
        
        <div class="tech-row">
          <span class="tech-label">Core</span>
          <div class="tech-items">
            <span class="tech-item">Python</span> <span class="tech-item">PyTorch</span> 
            <span class="tech-item">Lightning</span> <span class="tech-item">LangChain</span>
            <span class="tech-item">TensorFlow</span>
          </div>
        </div>
        
        <div class="tech-row">
          <span class="tech-label">Infra</span>
          <div class="tech-items">
            <span class="tech-item">AWS (EC2/S3/EFS)</span> <span class="tech-item">Docker</span> 
            <span class="tech-item">Milvus</span> <span class="tech-item">Flask</span>
            <span class="tech-item">Linux</span>
          </div>
        </div>
        
        <div class="tech-row">
          <span class="tech-label">Ops</span>
          <div class="tech-items">
            <span class="tech-item">MLflow</span> <span class="tech-item">W&B</span> 
            <span class="tech-item">Git</span> <span class="tech-item">SQL</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <section id="projects" class="work-section">
    <div class="section-header">
      <h2 class="section-title">Selected Deployments</h2>
      <a href="/projects" class="archive-link">VIEW FULL ARCHIVE →</a>
    </div>

    {featuredProjects.map((project) => {
      // Get homepage metric: use metrics array if available, otherwise fallback to legacy fields
      let metricValue = project.data.metric_value || '';
      let metricLabel = project.data.metric_label || '';
      
      if (project.data.metrics && project.data.metrics.length > 0) {
        const homepageIndex = project.data.homepage_metric_index ?? 0;
        const homepageMetric = project.data.metrics[homepageIndex];
        if (homepageMetric) {
          metricValue = homepageMetric.value;
          metricLabel = homepageMetric.label;
        }
      }
      
      return (
        <ProjectRow 
          url={`/projects/${project.slug}`}
          title={project.data.title}
          year={project.data.year}
          description={project.data.description}
          tags={project.data.tags}
          metric_value={metricValue}
          metric_label={metricLabel}
          githubUrl={project.data.github_url}
        />
      );
    })}
  </section>

  <footer>
    <span>© 2025 NIKHIL R. NIGAM // ALL SYSTEMS NOMINAL</span>
  </footer>
</BaseLayout>