---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Navbar from '@components/Navbar.astro';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  // Only generate paths for non-archived projects (explicit boolean check)
  return projects
    .filter((entry) => entry.data.archived !== true)
    .map((entry) => ({
      params: { slug: entry.slug },
      props: { entry },
    }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
---

<BaseLayout title={`${entry.data.title} | Nikhil R. Nigam`}>
  <Navbar />
  <div class="case-container">
    <article class="case-study">
      <span class="meta">PROJECT CASE STUDY // {entry.data.year}</span>
      <h1>{entry.data.title}</h1>

      {(() => {
        // Use new metrics array if available, otherwise fallback to legacy fields
        let metricsToShow = [];
        
        if (entry.data.metrics && entry.data.metrics.length > 0) {
          // Reorder metrics so homepage metric is first
          const homepageIndex = entry.data.homepage_metric_index ?? 0;
          const reorderedMetrics = [...entry.data.metrics];
          if (homepageIndex > 0 && homepageIndex < reorderedMetrics.length) {
            const [homepageMetric] = reorderedMetrics.splice(homepageIndex, 1);
            reorderedMetrics.unshift(homepageMetric);
          }
          metricsToShow = reorderedMetrics;
        } else if (entry.data.metric_value && entry.data.metric_label) {
          // Fallback to legacy format
          metricsToShow = [{ value: entry.data.metric_value, label: entry.data.metric_label }];
        }
        
        if (metricsToShow.length > 0) {
          return (
            <div class="metrics-grid">
              {metricsToShow.map((metric) => (
                <div class="metric-item">
                  <span class="metric-value">{metric.value}</span>
                  <span class="metric-label">{metric.label}</span>
                </div>
              ))}
            </div>
          );
        }
        return null;
      })()}

      <div class="case-study-content arithmatex">
        <Content />
      </div>
    </article>

    <div style="padding-bottom: 6rem;"></div>
  </div>
</BaseLayout>

<style>
  .metrics-grid {
    display: flex;
    gap: 0;
    margin: 3rem 0;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--line-color);
    border-radius: 4px;
    justify-content: space-around;
    align-items: center;
  }

  .metric-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    text-align: center;
  }

  .metric-item:not(:last-child) {
    border-right: 1px solid var(--line-color);
    padding-right: 2rem;
    margin-right: 2rem;
  }

  .metric-value {
    font-family: 'Space Grotesk', sans-serif;
    font-size: 3.5rem;
    font-weight: 700;
    color: var(--accent);
    display: block;
    line-height: 1;
    margin-bottom: 0.5rem;
  }

  .metric-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--text-muted);
    text-transform: uppercase;
    display: block;
  }

  @media (max-width: 768px) {
    .metrics-grid {
      flex-direction: column;
      gap: 1.5rem;
      padding: 1.5rem;
    }
    
    .metric-item {
      width: 100%;
    }
    
    .metric-item:not(:last-child) {
      border-right: none;
      border-bottom: 1px solid var(--line-color);
      padding-right: 0;
      margin-right: 0;
      padding-bottom: 1.5rem;
      margin-bottom: 1.5rem;
    }
    
    .metric-value {
      font-size: 2.5rem;
    }
  }
</style>
