---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Navbar from '@components/Navbar.astro';

export async function getStaticPaths() {
  const allProjects = await getCollection('projects');
  const pageSize = 8;
  const totalPages = Math.ceil(allProjects.length / pageSize);
  
  // Only generate paths for pages 2 and beyond (page 1 is handled by index.astro)
  if (totalPages <= 1) {
    return [];
  }
  
  return Array.from({ length: totalPages - 1 }, (_, i) => i + 2).map((pageNum) => ({
    params: { page: pageNum.toString() },
  }));
}

const allProjects = await getCollection('projects');
const sortedProjects = allProjects.sort((a, b) => {
  const yearCompare = b.data.year.localeCompare(a.data.year);
  if (yearCompare !== 0) return yearCompare;
  return a.data.title.localeCompare(b.data.title);
});

// Pagination settings
const pageSize = 8;
const currentPage = parseInt(Astro.params.page || '2');
const totalPages = Math.ceil(sortedProjects.length / pageSize);
const startIndex = (currentPage - 1) * pageSize;
const endIndex = startIndex + pageSize;
const paginatedProjects = sortedProjects.slice(startIndex, endIndex);
---

<BaseLayout title={`All Projects - Page ${currentPage} | Nikhil R. Nigam`}>
  <div class="container" style="max-width: 1200px;">
    <Navbar />

    <div class="archive-page">
      <h1>Project Archive</h1>

      {paginatedProjects.map((project) => (
        <a href={`/projects/${project.slug}`} class="archive-row">
          <div class="year">{project.data.year}</div>
          <div>
            <div class="archive-title">{project.data.title}</div>
            <p class="archive-desc">{project.data.description}</p>
          </div>
          <div class="archive-tags">
            {project.data.tags.map((tag) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        </a>
      ))}

      {totalPages > 1 && (
        <nav class="pagination">
          {currentPage > 1 ? (
            currentPage === 2 ? (
              <a href="/projects" class="pagination-link pagination-prev">← Previous</a>
            ) : (
              <a href={`/projects/page/${currentPage - 1}`} class="pagination-link pagination-prev">← Previous</a>
            )
          ) : (
            <span class="pagination-link pagination-prev disabled">← Previous</span>
          )}
          
          <div class="pagination-numbers">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => {
              if (pageNum === currentPage) {
                return <span class="pagination-number active">{pageNum}</span>;
              } else if (pageNum === 1) {
                return <a href="/projects" class="pagination-number">{pageNum}</a>;
              } else {
                return <a href={`/projects/page/${pageNum}`} class="pagination-number">{pageNum}</a>;
              }
            })}
          </div>

          {currentPage < totalPages ? (
            <a href={`/projects/page/${currentPage + 1}`} class="pagination-link pagination-next">Next →</a>
          ) : (
            <span class="pagination-link pagination-next disabled">Next →</span>
          )}
        </nav>
      )}
    </div>

    <div style="padding-bottom: 6rem;"></div>
  </div>
</BaseLayout>

