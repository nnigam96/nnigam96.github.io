---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Navbar from '@components/Navbar.astro';
import ProjectRow from '@components/ProjectRow.astro';

export async function getStaticPaths() {
  const allProjects = await getCollection('projects');
  // Filter out archived projects (explicit boolean check)
  const activeProjects = allProjects.filter((project) => project.data.archived !== true);
  const pageSize = 8;
  const totalPages = Math.ceil(activeProjects.length / pageSize);
  
  // Only generate paths for pages 2 and beyond (page 1 is handled by index.astro)
  if (totalPages <= 1) {
    return [];
  }
  
  return Array.from({ length: totalPages - 1 }, (_, i) => i + 2).map((pageNum) => ({
    params: { page: pageNum.toString() },
  }));
}

const allProjects = await getCollection('projects');
// Filter out archived projects (explicit boolean check)
const activeProjects = allProjects.filter((project) => project.data.archived !== true);
const sortedProjects = activeProjects.sort((a, b) => {
  const yearCompare = b.data.year.localeCompare(a.data.year);
  if (yearCompare !== 0) return yearCompare;
  return a.data.title.localeCompare(b.data.title);
});

// Pagination settings
const pageSize = 8;
const currentPage = parseInt(Astro.params.page || '2');
const totalPages = Math.ceil(sortedProjects.length / pageSize);
const startIndex = (currentPage - 1) * pageSize;
const endIndex = startIndex + pageSize;
const paginatedProjects = sortedProjects.slice(startIndex, endIndex);
---

<BaseLayout title={`All Projects - Page ${currentPage} | Nikhil R. Nigam`}>
  <Navbar />

  <div class="page-header">
    <h1>Project Archive</h1>
    <p class="page-subtitle">Shipping-grade ML systems spanning recommendation engines, agentic platforms, and privacy-first LLM stacks.</p>
  </div>

  {paginatedProjects.map((project) => {
      // Get homepage metric: use metrics array if available, otherwise fallback to legacy fields
      let metricValue = project.data.metric_value || '';
      let metricLabel = project.data.metric_label || '';
      
      if (project.data.metrics && project.data.metrics.length > 0) {
        const homepageIndex = project.data.homepage_metric_index ?? 0;
        const homepageMetric = project.data.metrics[homepageIndex];
        if (homepageMetric) {
          metricValue = homepageMetric.value;
          metricLabel = homepageMetric.label;
        }
      }

      return (
        <ProjectRow 
          url={`/projects/${project.slug}`}
          title={project.data.title}
          year={project.data.year}
          description={project.data.description}
          tags={project.data.tags}
          metric_value={metricValue}
          metric_label={metricLabel}
          githubUrl={project.data.github_url}
        />
      );
    })}

  {totalPages > 1 && (
    <nav class="pagination">
      {currentPage > 1 ? (
        currentPage === 2 ? (
          <a href="/projects" class="pagination-link pagination-prev">← Previous</a>
        ) : (
          <a href={`/projects/page/${currentPage - 1}`} class="pagination-link pagination-prev">← Previous</a>
        )
      ) : (
        <span class="pagination-link pagination-prev disabled">← Previous</span>
      )}
      
      <div class="pagination-numbers">
        {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => {
          if (pageNum === currentPage) {
            return <span class="pagination-number active">{pageNum}</span>;
          } else if (pageNum === 1) {
            return <a href="/projects" class="pagination-number">{pageNum}</a>;
          } else {
            return <a href={`/projects/page/${pageNum}`} class="pagination-number">{pageNum}</a>;
          }
        })}
      </div>

      {currentPage < totalPages ? (
        <a href={`/projects/page/${currentPage + 1}`} class="pagination-link pagination-next">Next →</a>
      ) : (
        <span class="pagination-link pagination-next disabled">Next →</span>
      )}
    </nav>
  )}

  <div style="padding-bottom: 6rem;"></div>
  <footer><span>© 2025 NIKHIL R. NIGAM</span></footer>
</BaseLayout>

