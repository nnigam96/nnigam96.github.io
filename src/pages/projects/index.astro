---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Navbar from '@components/Navbar.astro';
import ProjectRow from '@components/ProjectRow.astro'; // Import the component

const allProjects = await getCollection('projects');
// Filter out archived projects (explicit boolean check)
const activeProjects = allProjects.filter((project) => project.data.archived !== true);
const sortedProjects = activeProjects.sort((a, b) => {
  const yearCompare = b.data.year.localeCompare(a.data.year);
  if (yearCompare !== 0) return yearCompare;
  return a.data.title.localeCompare(b.data.title);
});

// Pagination settings
const pageSize = 8;
const currentPage = 1; // You might need logic here to read page param if doing dynamic pagination
const totalPages = Math.ceil(sortedProjects.length / pageSize);
const startIndex = (currentPage - 1) * pageSize;
const endIndex = startIndex + pageSize;
const paginatedProjects = sortedProjects.slice(startIndex, endIndex);
---

<BaseLayout title="All Projects | Nikhil R. Nigam">
  <Navbar />

  <div class="page-header">
    <h1>Project Archive</h1>
    <p class="page-subtitle">Shipping-grade ML systems spanning recommendation engines, agentic platforms, and privacy-first LLM stacks.</p>
  </div>

  {paginatedProjects.map((project) => {
         // Get homepage metric: use metrics array if available, otherwise fallback to legacy fields
        let metricValue = project.data.metric_value || '';
        let metricLabel = project.data.metric_label || '';
        
        if (project.data.metrics && project.data.metrics.length > 0) {
            // Default to first metric for archive list if specific index not set
            const homepageIndex = project.data.homepage_metric_index ?? 0;
            const homepageMetric = project.data.metrics[homepageIndex];
            if (homepageMetric) {
            metricValue = homepageMetric.value;
            metricLabel = homepageMetric.label;
            }
        }

        return (
            <ProjectRow 
            url={`/projects/${project.slug}`}
            title={project.data.title}
            year={project.data.year}
            description={project.data.description}
            tags={project.data.tags}
            metric_value={metricValue}
            metric_label={metricLabel}
            githubUrl={project.data.github_url}
            />
        );
      })}

  {totalPages > 1 && (
      <nav class="pagination">
        {currentPage > 1 ? (
          <a href="/projects" class="pagination-link pagination-prev">← Previous</a>
        ) : (
          <span class="pagination-link pagination-prev disabled">← Previous</span>
        )}
        
        <div class="pagination-numbers">
          {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => {
            if (pageNum === currentPage) {
              return <span class="pagination-number active">{pageNum}</span>;
            } else if (pageNum === 1) {
              return <a href="/projects" class="pagination-number">{pageNum}</a>;
            } else {
              return <a href={`/projects/page/${pageNum}`} class="pagination-number">{pageNum}</a>;
            }
          })}
        </div>

        {currentPage < totalPages ? (
          <a href={`/projects/page/${currentPage + 1}`} class="pagination-link pagination-next">Next →</a>
        ) : (
          <span class="pagination-link pagination-next disabled">Next →</span>
        )}
      </nav>
    )}
  
  <div style="padding-bottom: 6rem;"></div>
  <footer><span>© 2025 NIKHIL R. NIGAM</span></footer>
</BaseLayout>