---
import { getCollection } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Navbar from '@components/Navbar.astro';

const allProjects = await getCollection('projects');
// Filter out archived projects (explicit boolean check)
const activeProjects = allProjects.filter((project) => project.data.archived !== true);
const sortedProjects = activeProjects.sort((a, b) => {
  const yearCompare = b.data.year.localeCompare(a.data.year);
  if (yearCompare !== 0) return yearCompare;
  return a.data.title.localeCompare(b.data.title);
});

// Pagination settings
const pageSize = 8;
const currentPage = 1;
const totalPages = Math.ceil(sortedProjects.length / pageSize);
const startIndex = (currentPage - 1) * pageSize;
const endIndex = startIndex + pageSize;
const paginatedProjects = sortedProjects.slice(startIndex, endIndex);
---

<BaseLayout title="All Projects | Nikhil R. Nigam">
  <Navbar />

    <div class="page-header">
      <h1>Project Archive</h1>
      <p class="page-subtitle">Shipping-grade ML systems spanning recommendation engines, agentic platforms, and privacy-first LLM stacks.</p>
    </div>

    {paginatedProjects.map((project) => (
        <a href={`/projects/${project.slug}`} class="archive-row">
          <div class="year">{project.data.year}</div>
          <div>
            <div class="archive-title">{project.data.title}</div>
            <p class="archive-desc">{project.data.description}</p>
          </div>
          <div class="archive-tags">
            {project.data.tags.map((tag) => (
              <span class="tag">{tag}</span>
            ))}
          </div>
        </a>
      ))}

    {totalPages > 1 && (
      <nav class="pagination">
        {currentPage > 1 ? (
          <a href="/projects" class="pagination-link pagination-prev">← Previous</a>
        ) : (
          <span class="pagination-link pagination-prev disabled">← Previous</span>
        )}
        
        <div class="pagination-numbers">
          {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => {
            if (pageNum === currentPage) {
              return <span class="pagination-number active">{pageNum}</span>;
            } else if (pageNum === 1) {
              return <a href="/projects" class="pagination-number">{pageNum}</a>;
            } else {
              return <a href={`/projects/page/${pageNum}`} class="pagination-number">{pageNum}</a>;
            }
          })}
        </div>

        {currentPage < totalPages ? (
          <a href={`/projects/page/${currentPage + 1}`} class="pagination-link pagination-next">Next →</a>
        ) : (
          <span class="pagination-link pagination-next disabled">Next →</span>
        )}
      </nav>
    )}
  </div>
</BaseLayout>
